<h1>Tenant Information</h1>
<br/>
<div *ngIf="pendingTenants && pendingTenants.length > 0">
    <h2>Pending Tenants</h2>
    <p-table [value]="pendingTenants" dataKey="user_id">
      <ng-template pTemplate="header">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Action</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-tenant>
        <tr>
          <td>{{tenant.first_name}} {{tenant.last_name}}</td>
          <td>{{tenant.email}}</td>
          <td>
            <p-button icon="pi pi-check" severity="success" (click)="Confirm(tenant)"></p-button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

<div class="card" style="overflow-y: auto;">
    <p-table 
        [value]="leases" dataKey="lease_agreement_id" (onEditComplete)="onEditComplete($event)"
        [scrollable]="true" 
        scrollHeight="500px"[tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
                <tr>
                    <th>Name</th>
                    <th>Monthly Rent</th>
                    <th>Contract</th>
                    <th>Number of Months</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Remaining Balance</th>
                    <th>Validated</th>
                </tr>
            </ng-template>
    
            <ng-template pTemplate="body" let-lease let-editing="editing">
                <tr >
                    <td>{{lease.tenantName}}</td>

                    <td *ngIf="lease.is_validated; else readonlyMonthlyRent" [pEditableColumnRowIndex]="lease.lease_agreement_id" [pEditableColumn]="lease.monthly_rent" pEditableColumnField="monthly_rent">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="number" [(ngModel)]="lease.monthly_rent" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ lease.monthly_rent | currency: 'PHP' }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <ng-template #readonlyMonthlyRent>
                        <td>{{ lease.monthly_rent | currency: 'PHP' }}</td>
                    </ng-template>


                    <td *ngIf="lease.is_validated; else readonlyContract" [pEditableColumnRowIndex]="lease.lease_agreement_id" [pEditableColumn]="lease.contract" pEditableColumnField="contract">
                        <p-cellEditor>
                        <ng-template pTemplate="input">
                            <div *ngIf="imageSrc">
                                <img [src]="imageSrc ? imageSrc : selectedItem.image_path" alt="Uploaded Image">
                            </div>
                            <p-fileUpload mode="basic" 
                                          chooseLabel="Choose" 
                                          accept="image/*" 
                                          [maxFileSize]="1000000" 
                                          (uploadHandler)="storeImageData($event, selectedItem?.lease_agreement_id)" 
                                          chooseLabel="Browse" 
                                          [customUpload]="true" 
                                          invalidFileTypeMessageDetail="Allowed file types: jpg, jpeg, png, gif, bmp" 
                                          width="100">
                            </p-fileUpload>
                        </ng-template>
                        <ng-template pTemplate="output">
                            <div *ngIf="imageSrc">
                                <img [src]="imageSrc ? imageSrc : selectedItem.image_path" alt="Uploaded Image">
                            </div>
                    </ng-template>
                    </p-cellEditor>
                    </td>
                    <ng-template #readonlyContract>
                        <td>
                            <img *ngIf="imageSrc" [src]="imageSrc ? imageSrc : selectedItem.image_path" alt="Uploaded Image">
                        </td>
                    </ng-template>
            
                    <td *ngIf="lease.is_validated; else readonlyNumberOfMonths" [pEditableColumnRowIndex]="lease.lease_agreement_id" [pEditableColumn]="lease.numberOfMonths" pEditableColumnField="numberOfMonths">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <p-inputNumber inputId="integeronly" type="number"
                                               [(ngModel)]="lease.numberOfMonths"
                                               placeholder="Months"
                                               [disabled]="lease.startDateSaved"
                                               (ngModelChange)="onNumberOfMonthsChange(lease)"
                                               [inputStyle]="{'width':'100px'}"
                                               [min]="1" [max]="12">
                                </p-inputNumber>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ lease.numberOfMonths }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <ng-template #readonlyNumberOfMonths>
                        <td>{{ lease.numberOfMonths }}</td>
                    </ng-template>

                    <td *ngIf="lease.is_validated; else readonlyStartDate" [pEditableColumnRowIndex]="lease.lease_agreement_id" [pEditableColumn]="lease.start_date" pEditableColumnField="start_date">
                <p-cellEditor>
                    <ng-template pTemplate="input">
                        <p-calendar [(ngModel)]="lease.start_date"
                                    [ngModelOptions]="{standalone: true}"
                                    (ngModelChange)="onStartDateChange(lease)"
                                    [iconDisplay]="'input'"
                                    [showIcon]="true"
                                    [touchUI]="true"
                                    [minDate]="today"
                                    [inputStyle]="{'width':'150px'}"
                                    inputId="start_date">
                        </p-calendar>
                    </ng-template>
                    <ng-template pTemplate="output">
                        {{ lease.start_date | date:'shortDate' }} 
                    </ng-template>
                </p-cellEditor>
            </td>
            <ng-template #readonlyStartDate>
                <td>{{ lease.start_date | date:'shortDate' }}</td>
            </ng-template>

            <td>{{ lease.end_date | date:'shortDate' }}</td>
                    
                    <td *ngIf="lease.is_validated; else readonlyRemainingBalance" [pEditableColumnRowIndex]="lease.lease_agreement_id" [pEditableColumn]="lease.remaining_balance" pEditableColumnField="remaining_balance">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <input pInputText type="number" [(ngModel)]="lease.remaining_balance" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ lease.remaining_balance | currency: 'PHP' }}
                            </ng-template>
                        </p-cellEditor>
                    </td>
                    <ng-template #readonlyRemainingBalance>
                        <td>{{ lease.remaining_balance | currency: 'PHP' }}</td>
                    </ng-template>

                    <td>
                        <p-dropdown *ngIf="editingValidationStatus[lease.lease_agreement_id]"
                            [options]="validationOptions" 
                            [(ngModel)]="lease.validationStatus" 
                            (onChange)="onValidationChange($event, lease)"
                            (onBlur)="editingValidationStatus[lease.lease_agreement_id] = false"
                            optionLabel="label" 
                            optionValue="value">
                        </p-dropdown>
                        <div *ngIf="!editingValidationStatus[lease.lease_agreement_id]" 
                             (click)="editingValidationStatus[lease.lease_agreement_id] = true">
                            <p-tag *ngIf="lease.validationStatus === 'valid'" 
                                severity="success" 
                                value="Yes">
                            </p-tag>
                            <p-tag *ngIf="lease.validationStatus === 'invalid'" 
                                severity="danger" 
                                value="No">
                            </p-tag>
                            <p-tag *ngIf="!lease.validationStatus" 
                                severity="warning" 
                                value="Select">
                            </p-tag>
                        </div>
                    </td>
                </tr>
            </ng-template>
    </p-table>
</div>

<div class="card" style="margin-top: 20px;">
    <h2>Compute Remaining Balance</h2>
    <p-table [value]="leases" dataKey="lease_agreement_id">
        <ng-template pTemplate="header">
            <tr>
                <th>Name</th>
                <th>Amount</th>
                <!-- <th>Remaining Balance</th> -->
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-lease>
            <tr>
                <td>{{lease.tenantName}}</td>
                
                <td>
                <div class="d-flex flex-column align-items-start">
                <p-inputNumber inputId="currency-philippines" mode="currency"
                [(ngModel)]="lease.updatedMonthlyRent"
                currency="PHP"
                [inputStyle]="{'width':'150px'}">
                <ng-template pTemplate="input">
                </ng-template>
                </p-inputNumber>
                <button pButton pRipple label="Compute" class="p-button-danger mt-2" (click)="updateRent(lease)"></button>
                </div>
                </td>

                <!-- <td>{{ lease.remaining_balance | currency: 'PHP' }} </td> -->
                
            </tr>
        </ng-template>
    </p-table>
</div>

<h2>Payment History</h2>
<p-table [value]="leases">
    <ng-template pTemplate="body" let-lease>
      <tr>
        <td colspan="8">
          <p-table [value]="lease.paymentHistory" styleClass="payment-history-table">
            <ng-template pTemplate="header">
              <tr>
                <th>Date of Payment</th>
                <th>Payment Amount</th>
                <th>Remaining Balance</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-payment>
              <tr>
                <td>{{ payment.date | date:'longDate' }}</td>
                <td>{{ payment.paymentAmount | currency: 'PHP' }}</td>
                <td>{{ payment.remainingBalance | currency: 'PHP' }}</td>
              </tr>
            </ng-template>
          </p-table>
        </td>
      </tr>
    </ng-template>
  </p-table>
  